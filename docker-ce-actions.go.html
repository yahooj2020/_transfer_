{% extends "docker-ce-template.html" %} 
{% block body %} 

<div><a class="previous"  style="text-align: left;" href="/detail/docker-ce-encoder.go.html">Previous : encoder.go</a>&nbsp<a class="next"   style="text-align: right;" href="/detail/docker-ce-fake.go.html">Next : fake.go</a></div><br>
<div class="codehilite"><pre><span></span><code><span class="o">//</span> <span class="n">Copyright</span> <span class="mi">2009</span> <span class="n">The</span> <span class="n">Go</span> <span class="n">Authors</span><span class="o">.</span> <span class="n">All</span> <span class="n">rights</span> <span class="n">reserved</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Use</span> <span class="n">of</span> <span class="n">this</span> <span class="n">source</span> <span class="n">code</span> <span class="ow">is</span> <span class="n">governed</span> <span class="n">by</span> <span class="n">a</span> <span class="n">BSD</span><span class="o">-</span><span class="n">style</span>
<span class="o">//</span> <span class="n">license</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">LICENSE</span> <span class="n">file</span><span class="o">.</span>

<span class="o">//</span><span class="n">go</span><span class="p">:</span><span class="n">build</span> <span class="n">aix</span> <span class="o">||</span> <span class="n">darwin</span> <span class="o">||</span> <span class="n">dragonfly</span> <span class="o">||</span> <span class="n">freebsd</span> <span class="o">||</span> <span class="n">linux</span> <span class="o">||</span> <span class="n">netbsd</span> <span class="o">||</span> <span class="n">openbsd</span> <span class="o">||</span> <span class="n">solaris</span>
<span class="o">//</span> <span class="o">+</span><span class="n">build</span> <span class="n">aix</span> <span class="n">darwin</span> <span class="n">dragonfly</span> <span class="n">freebsd</span> <span class="n">linux</span> <span class="n">netbsd</span> <span class="n">openbsd</span> <span class="n">solaris</span>

<span class="n">package</span> <span class="n">unix</span>

<span class="kn">import</span> <span class="s2">&quot;unsafe&quot;</span>

<span class="o">//</span> <span class="n">readInt</span> <span class="n">returns</span> <span class="n">the</span> <span class="n">size</span><span class="o">-</span><span class="nb">bytes</span> <span class="n">unsigned</span> <span class="n">integer</span> <span class="ow">in</span> <span class="n">native</span> <span class="n">byte</span> <span class="n">order</span> <span class="n">at</span> <span class="n">offset</span> <span class="n">off</span><span class="o">.</span>
<span class="n">func</span> <span class="n">readInt</span><span class="p">(</span><span class="n">b</span> <span class="p">[]</span><span class="n">byte</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">size</span> <span class="n">uintptr</span><span class="p">)</span> <span class="p">(</span><span class="n">u</span> <span class="n">uint64</span><span class="p">,</span> <span class="n">ok</span> <span class="nb">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">off</span><span class="o">+</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">false</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">isBigEndian</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">readIntBE</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">off</span><span class="p">:],</span> <span class="n">size</span><span class="p">),</span> <span class="n">true</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">readIntLE</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">off</span><span class="p">:],</span> <span class="n">size</span><span class="p">),</span> <span class="n">true</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">readIntBE</span><span class="p">(</span><span class="n">b</span> <span class="p">[]</span><span class="n">byte</span><span class="p">,</span> <span class="n">size</span> <span class="n">uintptr</span><span class="p">)</span> <span class="n">uint64</span> <span class="p">{</span>
    <span class="n">switch</span> <span class="n">size</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">bounds</span> <span class="n">check</span> <span class="n">hint</span> <span class="n">to</span> <span class="n">compiler</span><span class="p">;</span> <span class="n">see</span> <span class="n">golang</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">issue</span><span class="o">/</span><span class="mi">14808</span>
        <span class="k">return</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">8</span>
    <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">//</span> <span class="n">bounds</span> <span class="n">check</span> <span class="n">hint</span> <span class="n">to</span> <span class="n">compiler</span><span class="p">;</span> <span class="n">see</span> <span class="n">golang</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">issue</span><span class="o">/</span><span class="mi">14808</span>
        <span class="k">return</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">8</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">24</span>
    <span class="k">case</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">//</span> <span class="n">bounds</span> <span class="n">check</span> <span class="n">hint</span> <span class="n">to</span> <span class="n">compiler</span><span class="p">;</span> <span class="n">see</span> <span class="n">golang</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">issue</span><span class="o">/</span><span class="mi">14808</span>
        <span class="k">return</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">8</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">24</span> <span class="o">|</span>
            <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">32</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">40</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">48</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">56</span>
    <span class="n">default</span><span class="p">:</span>
        <span class="n">panic</span><span class="p">(</span><span class="s2">&quot;syscall: readInt with unsupported size&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">readIntLE</span><span class="p">(</span><span class="n">b</span> <span class="p">[]</span><span class="n">byte</span><span class="p">,</span> <span class="n">size</span> <span class="n">uintptr</span><span class="p">)</span> <span class="n">uint64</span> <span class="p">{</span>
    <span class="n">switch</span> <span class="n">size</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">bounds</span> <span class="n">check</span> <span class="n">hint</span> <span class="n">to</span> <span class="n">compiler</span><span class="p">;</span> <span class="n">see</span> <span class="n">golang</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">issue</span><span class="o">/</span><span class="mi">14808</span>
        <span class="k">return</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">8</span>
    <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">//</span> <span class="n">bounds</span> <span class="n">check</span> <span class="n">hint</span> <span class="n">to</span> <span class="n">compiler</span><span class="p">;</span> <span class="n">see</span> <span class="n">golang</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">issue</span><span class="o">/</span><span class="mi">14808</span>
        <span class="k">return</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">8</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">24</span>
    <span class="k">case</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">//</span> <span class="n">bounds</span> <span class="n">check</span> <span class="n">hint</span> <span class="n">to</span> <span class="n">compiler</span><span class="p">;</span> <span class="n">see</span> <span class="n">golang</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">issue</span><span class="o">/</span><span class="mi">14808</span>
        <span class="k">return</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">8</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">24</span> <span class="o">|</span>
            <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">32</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">40</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">48</span> <span class="o">|</span> <span class="n">uint64</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">56</span>
    <span class="n">default</span><span class="p">:</span>
        <span class="n">panic</span><span class="p">(</span><span class="s2">&quot;syscall: readInt with unsupported size&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">ParseDirent</span> <span class="n">parses</span> <span class="n">up</span> <span class="n">to</span> <span class="nb">max</span> <span class="n">directory</span> <span class="n">entries</span> <span class="ow">in</span> <span class="n">buf</span><span class="p">,</span>
<span class="o">//</span> <span class="n">appending</span> <span class="n">the</span> <span class="n">names</span> <span class="n">to</span> <span class="n">names</span><span class="o">.</span> <span class="n">It</span> <span class="n">returns</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span>
<span class="o">//</span> <span class="nb">bytes</span> <span class="n">consumed</span> <span class="kn">from</span> <span class="nn">buf</span><span class="p">,</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">entries</span> <span class="n">added</span>
<span class="o">//</span> <span class="n">to</span> <span class="n">names</span><span class="p">,</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">new</span> <span class="n">names</span> <span class="nb">slice</span><span class="o">.</span>
<span class="n">func</span> <span class="n">ParseDirent</span><span class="p">(</span><span class="n">buf</span> <span class="p">[]</span><span class="n">byte</span><span class="p">,</span> <span class="nb">max</span> <span class="nb">int</span><span class="p">,</span> <span class="n">names</span> <span class="p">[]</span><span class="n">string</span><span class="p">)</span> <span class="p">(</span><span class="n">consumed</span> <span class="nb">int</span><span class="p">,</span> <span class="n">count</span> <span class="nb">int</span><span class="p">,</span> <span class="n">newnames</span> <span class="p">[]</span><span class="n">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">origlen</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="nb">max</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="n">reclen</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">direntReclen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="k">if</span> <span class="err">!</span><span class="n">ok</span> <span class="o">||</span> <span class="n">reclen</span> <span class="o">&gt;</span> <span class="n">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">origlen</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">names</span>
        <span class="p">}</span>
        <span class="n">rec</span> <span class="o">:=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">reclen</span><span class="p">]</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">reclen</span><span class="p">:]</span>
        <span class="n">ino</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">direntIno</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="k">if</span> <span class="err">!</span><span class="n">ok</span> <span class="p">{</span>
            <span class="k">break</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">ino</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span> <span class="o">//</span> <span class="n">File</span> <span class="n">absent</span> <span class="ow">in</span> <span class="n">directory</span><span class="o">.</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        <span class="n">const</span> <span class="n">namoff</span> <span class="o">=</span> <span class="n">uint64</span><span class="p">(</span><span class="n">unsafe</span><span class="o">.</span><span class="n">Offsetof</span><span class="p">(</span><span class="n">Dirent</span><span class="p">{}</span><span class="o">.</span><span class="n">Name</span><span class="p">))</span>
        <span class="n">namlen</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">direntNamlen</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="k">if</span> <span class="err">!</span><span class="n">ok</span> <span class="o">||</span> <span class="n">namoff</span><span class="o">+</span><span class="n">namlen</span> <span class="o">&gt;</span> <span class="n">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rec</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">break</span>
        <span class="p">}</span>
        <span class="n">name</span> <span class="o">:=</span> <span class="n">rec</span><span class="p">[</span><span class="n">namoff</span> <span class="p">:</span> <span class="n">namoff</span><span class="o">+</span><span class="n">namlen</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="o">:=</span> <span class="nb">range</span> <span class="n">name</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="o">//</span> <span class="n">Check</span> <span class="k">for</span> <span class="n">useless</span> <span class="n">names</span> <span class="n">before</span> <span class="n">allocating</span> <span class="n">a</span> <span class="n">string</span><span class="o">.</span>
        <span class="k">if</span> <span class="n">string</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span> <span class="o">||</span> <span class="n">string</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;..&quot;</span> <span class="p">{</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        <span class="nb">max</span><span class="o">--</span>
        <span class="n">count</span><span class="o">++</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">append</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">string</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">origlen</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">count</span><span class="p">,</span> <span class="n">names</span>
<span class="p">}</span>
</code></pre></div>

{% endblock %}
